var express = require('express');var session =require('express-session');var morgan = require('morgan'); // Charge le middleware de loggingvar logger = require('log4js').getLogger('Server');var bodyParser = require('body-parser');var mysql = require('mysql');var app = express();// configapp.set('view engine', 'ejs');app.set('views', __dirname + '/views');app.use(bodyParser.urlencoded({extended: false}));app.use(morgan('combined')); // Active le middleware de loggingapp.use(session({secret:"marcelproust",resave:false, saveUninitialized:true}));app.use(express.static(__dirname + '/www')); // Indique que le dossier /public contient des fichiers statiques (middleware chargé de base)logger.info('server start');app.get('/', function (req, res) {    res.redirect('/login');});app.get('/login', function (req, res) {    res.render('login');});app.post('/login', function (req, res) {    var connection = mysql.createConnection({        host: 'localhost',        user: 'test',        password: 'test',        database: 'pictionnary'    });    if (!connection.connect()) {        console.log("No connection");    }    var email = req.body.email;    var password = req.body.password;    console.log(email);    console.log(password);   connection.query("SELECT * from users where email = \"" + email + "\" and password = \"" + password + "\"", function (err, rows) {        if (!err) {            logger.info('Le résultat de la requête: ', rows);        }        else {            logger.error(err);        }        if (rows.length > 0) {            rows=rows[0];            req.session.iduser=rows['id'];            req.session.email=rows['email'];            req.session.nom=rows['nom'];            req.session.prenom=rows['prenom'];            req.session.tel=rows['tel'];            req.session.website=rows['website'];            req.session.birthdate=rows['birthdate'];            req.session.ville=rows['ville'];            req.session.taille=rows['taille'];            req.session.couleur=rows['couleur'];            req.session.profilepic=rows['profilepic'].toString('utf8');            req.session.admin=rows['admin'];            console.log(req.session.admin);          if (req.session.admin=='A') {              res.redirect('/dashboard');          }else {              res.redirect('/main');          }        } else {            res.redirect('/login');        }        connection.end();    });});//FB work in progress/*app.post('/facebook', function(req,res){    var email=req.body.email;    var name=req.body.name;    var password=req.body.id;});*/app.get('/inscription', function(req, res) {    res.render('inscription', {keep:req.keep});});app.post('/inscription', function(req, res) {    var connection = mysql.createConnection({        host     : 'localhost',        user     : 'test',        password : 'test',        database : 'pictionnary'    });    var birthdate=req.body.birthdate;    var day =birthdate.slice(0,2);    var mois =birthdate.slice(3,5);    var year=birthdate.slice(6,10);    var birthdateCorect=year+"-"+mois+"-"+day;    var couleur = req.body.couleur;    var couleurCorrect = couleur.slice(1,7);    logger.info("Birthdate :",birthdate);    logger.info("day :",day);    logger.info("birthdateCorect :",birthdateCorect);    var post = {email: req.body.email, password: req.body.password, nom: req.body.nom, prenom: req.body.prenom, tel: req.body.tel, website: req.body.website, sexe: req.body.sexe, birthdate: birthdateCorect, ville: req.body.ville, taille: req.body.taille, couleur: couleurCorrect, profilepic: req.body.profilepic};    connection.connect();    connection.query("SELECT COUNT(*) AS numberRow FROM users WHERE email=? ", req.body.email, function(err, rows, fields) {        if (!err) {            if(rows[0]['numberRow'] == 0) {               var testInsert= connection.query('INSERT INTO users SET ?', post, function(err, result) {                   logger.info('Info insert :',testInsert);                   if(!err) {                        res.redirect('/login');                    } else {                        res.render('inscription');                        logger.info('Error while performing Query insert.' + err);                    }                });            } else {                var keep = "nom=" + req.body.nom +                    "&prenom=" + req.body.prenom +                    '&tel=' + req.body.tel +                    '&website=' + req.body.website +                    '&sexe=' + req.body.sexe +                    '&birthdate=' + req.body.birthdate +                    '&ville=' + req.body.ville +                    '&taille=' + req.body.taille +                    '&couleur=' + req.body.couleur                res.redirect('inscription/?' + keep);            }            connection.end();        }    });});app.use(function(req, res, next) {    if (req.session.email == undefined) {        // if user is not logged-in redirect back to login page //        res.render('login', {            title: 'Please Login To Your Account'        });    } else {        next();    }});app.get('/main', function (req, res) {    var connection = mysql.createConnection({        host: 'localhost',        user: 'test',        password: 'test',        database: 'pictionnary'    });    connection.connect();    connection.query("SELECT * from drawings where iduser = \"" + req.session.iduser + "\"", function (err, rows) {        console.log(rows);        res.render('main',{prenom:req.session.prenom, profilepic:req.session.profilepic, idpic:rows});    })    connection.end();});app.get('/header',function(req,res){    res.render('header',{prenom:req.session.prenom, profilepic:req.session.profilepic});});app.get('/profile',  function (req, res) {    res.render('profile',{email:req.session.email,tel:req.session.tel,nom:req.session.nom,prenom:req.session.prenom,website:req.session.website,birthdate:req.session.birthdate,ville:req.session.ville,taille:req.session.taille,couleur:req.session.couleur,profilepic:req.session.profilepic});});app.get('/modification',  function (req, res) {    res.render('modification',{email:req.session.email,prenom:req.session.prenom,tel:req.session.tel,nom:req.session.nom,website:req.session.website,ville:req.session.ville,taille:req.session.taille,couleur:req.session.couleur,profilepic:req.session.profilepic});});app.post('/modification', function (req, res){    var connection = mysql.createConnection({        host: 'localhost',        user: 'test',        password: 'test',        database: 'pictionnary'    });    if (!connection.connect()) {        console.log("No connection");    }    var id = req.session.iduser;    var data = {        email : req.body.email,        password : req.body.password,        nom : req.body.nom,        tel : req.body.tel,        website : req.body.website,        ville : req.body.ville,        taille : req.body.taille,        couleur : req.body.couleur,        profilepic : req.body.profilepic    };      var test =connection.query('UPDATE users SET ? where id= ?',[data,id], function(err, results) {                        req.session.email = req.body.email;                        req.session.nom = req.body.nom;                        req.session.tel=req.body.tel;                        req.session.website=req.body.website;                        req.session.ville=req.body.ville;                        req.session.taille=req.body.taille;                        req.session.couleur = req.body.couleur;                        req.session.profilepic = req.body.profilepic;          logger.info("Voir la requete:",test);      })    res.redirect('/main');    connection.end();});app.get('/supression', function(req, res) {    logger.info("I am in :");    var connection = mysql.createConnection({        host     : 'localhost',        user     : 'test',        password : 'test',        database : 'pictionnary'    });        connection.connect();       var testDlete= connection.query("Delete FROM users WHERE id=? ", req.session.iduser, function(err, rows, fields) {            logger.info("Command :",testDlete);            connection.end();            res.redirect('login');        })});app.get('/dashboard', function (req, res) {    var connection = mysql.createConnection({        host: 'localhost',        user: 'test',        password: 'test',        database: 'pictionnary'    });    connection.connect();    connection.query("SELECT * from users", function (err, rows) {        console.log(rows);        res.render('dashboard',{prenom:req.session.prenom, profilepic:req.session.profilepic, user:rows});    })    connection.end();});app.get('/modificationadm', function(req,res){    var connection = mysql.createConnection({        host: 'localhost',        user: 'test',        password: 'test',        database: 'pictionnary'    });    connection.connect();    var iduser =req.query.iduser;    connection.query("SELECT * from users where id=?",[iduser], function (err, rows) {        console.log(rows);        res.render('modificationadm',{user:rows[0]});    })    connection.end();});app.post('/modificationadm',function(req,res){    var connection = mysql.createConnection({        host: 'localhost',        user: 'test',        password: 'test',        database: 'pictionnary'    });    if (!connection.connect()) {        console.log("No connection");    }    var iduser =req.query.iduser;    var data = {        email : req.body.email,        password : req.body.password,        nom : req.body.nom,        tel : req.body.tel,        website : req.body.website,        ville : req.body.ville,        taille : req.body.taille,        couleur : req.body.couleur,        profilepic : req.body.profilepic    };    var test =connection.query('UPDATE users SET ? where id= ?',[data,iduser], function(err, results) {        req.session.email = req.body.email;        req.session.nom = req.body.nom;        req.session.tel=req.body.tel;        req.session.website=req.body.website;        req.session.ville=req.body.ville;        req.session.taille=req.body.taille;        req.session.couleur = req.body.couleur;        req.session.profilepic = req.body.profilepic;        logger.info("Voir la requete:",test);    })    res.redirect('/dashboard');    connection.end();});app.post('/supressionadm', function(req, res) {    logger.info("I am in :");    var connection = mysql.createConnection({        host     : 'localhost',        user     : 'test',        password : 'test',        database : 'pictionnary'    });    connection.connect();    var data = req.body.iduser;    console.log(data);    var testDlete= connection.query("Delete FROM users WHERE id=? ",[data], function(err, rows, fields) {        logger.info("Command :",testDlete);        connection.end();        res.redirect('/dashboard');    })});app.get('/logout',function(req,res){    delete req.session.iduser;    delete req.session.email;    delete req.session.nom;    delete req.session.prenom;    delete req.session.tel;    delete req.session.website;    delete req.session.birthdate=;    delete req.session.ville;    delete req.session.taille;    delete req.session.couleur;    delete req.session.profilepic;    delete req.session.admin;    console.log(req.session);    res.redirect('/login');});app.listen(1313);